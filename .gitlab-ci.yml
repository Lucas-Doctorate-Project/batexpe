image: oarteam/robin_ci

###############################################################################
# Variables
###############################################################################
variables:
  GIT_SUBMODULE_STRATEGY: none # TODO: set to normal (for vendoring)
  REPO_NAME: gitlab.inria.fr/batsim/batexpe
  GO_PATH: /root/go
  BATSIM_DIR: /batsim

###############################################################################
# Before script
###############################################################################
before_script:
  - export PATH="${CI_PROJECT_DIR}/artifacts:${PATH}"

###############################################################################
# Build stage
###############################################################################
build:
  stage: build
  script:
    # Put batexpe source in the go source tree (so vendoring works as expected)
    - mkdir -p ${GO_PATH}/src/${REPO_NAME}
    - mv ${CI_PROJECT_DIR}/* ${GO_PATH}/src/${REPO_NAME}
    - cd ${GO_PATH}/src/${REPO_NAME}
    # Go dependencies
    - go get .
    # Prepare artifacts
    - mkdir -p ${CI_PROJECT_DIR}/artifacts
    # Build robin
    - go build -o ${CI_PROJECT_DIR}/artifacts/robin ./cmd/robin
    # Build robintest
    - go build -o ${CI_PROJECT_DIR}/artifacts/robin ./cmd/robintest
  artifacts:
    paths:
      - ${CI_PROJECT_DIR}/artifacts/robin
      - ${CI_PROJECT_DIR}/artifacts/robintest

###############################################################################
# Test stage
###############################################################################
cli:
  stage: test
  script:
    - robin --version
    - robin --help
    - robin -h
  dependencies:
    - build

test_should_pass:
  stage: test
  script:
    - cd ${CI_PROJECT_DIR}/test/robin
    - killall batsim batsched ; robintest batsched_ok.yaml --test-timeout 30 --expect-robin-success --expect-batsim-success --expect-sched-success --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsim_nosched_ok.yaml --test-timeout 30 --expect-robin-success --expect-batsim-success --expect-no-sched
  dependencies:
    - build

test_should_fail:
  stage: test
  script:
    - cd ${CI_PROJECT_DIR}/test/robin
    - killall batsim batsched ; robintest batsched_badport.yaml --test-timeout 20 --expect-robin-killed --expect-batsim-killed --expect-sched-killed --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_badwritedir.yaml --test-timeout 30 --expect-robin-failure --expect-batsim-failure --expect-sched-killed --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_timeout.yaml --test-timeout 5 --expect-robin-failure --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsim_badsched_nosuchcmd.yaml --test-timeout 30 --expect-robin-failure --expect-batsim-killed --expect-sched-failure --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsim_badsched_wrongcmd.yaml --test-timeout 30 --expect-robin-failure --expect-batsim-killed --expect-sched-success --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsim_nosched_badbash.yaml --test-timeout 30 --expect-robin-failure --expect-batsim-failure --expect-no-sched
    - killall batsim batsched ; robintest batsim_nosched_badinput.yaml --test-timeout 30 --expect-robin-failure --expect-batsim-failure --expect-no-sched
    - killall batsim batsched ; robintest batsim_nosched_timeout.yaml --test-timeout 5 --expect-robin-failure --expect-no-sched
  dependencies:
    - build

test_schedcrash:
  stage: test
  script:
    - cd ${CI_PROJECT_DIR}/test/robin
    - killall batsim batsched ; robintest batsched_schedcrash_badargs.yaml --test-timeout 30 --expect-robin-failure --expect-batsim-killed --expect-sched-failure --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_schedcrash_begin_loop.yaml --test-timeout 20 --expect-robin-failure --expect-batsim-killed --expect-sched-killed --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_schedcrash_begin_loop.yaml --test-timeout 10 --expect-robin-killed --expect-batsim-killed --expect-sched-killed --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_schedcrash_begin_segfault.yaml --test-timeout 30 --expect-robin-failure --expect-batsim-killed --expect-sched-failure --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_schedcrash_mid_loop.yaml --test-timeout 20 --expect-robin-failure --expect-batsim-killed --expect-sched-killed --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_schedcrash_mid_loop.yaml --test-timeout 10 --expect-robin-killed --expect-batsim-killed --expect-sched-killed --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_schedcrash_mid_segfault.yaml --test-timeout 30 --expect-robin-failure --expect-batsim-killed --expect-sched-failure --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_schedcrash_end_loop.yaml --test-timeout 20 --expect-robin-failure --expect-batsim-killed --expect-sched-killed --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_schedcrash_end_loop.yaml --test-timeout 10 --expect-robin-killed --expect-batsim-killed --expect-sched-killed --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
    - killall batsim batsched ; robintest batsched_schedcrash_end_segfault.yaml --test-timeout 30 --expect-robin-failure --expect-batsim-killed --expect-sched-failure --expect-ctx-clean --expect-ctx-clean-at-begin --expect-ctx-clean-at-end
  dependencies:
    - build
